<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIZZA SHOP | åˆ›ä½œå·¥åŠ Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        :root { --red: #d63031; --yellow: #feca57; --paper: #fffcf2; --green: #27ae60; --dark: #2d3436; --blue: #0984e3; }
        body { font-family: 'PingFang SC', sans-serif; background: #f7f1e3; margin: 0; padding-bottom: 50px; }
        
        .page { display: none; width: 100%; max-width: 600px; margin: 0 auto; padding: 20px; box-sizing: border-box; }
        .active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* é¦–é¡µæ ·å¼ */
        .main-menu { text-align: center; background: white; border-radius: 30px; padding: 30px 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); margin-top: 20px; border: 5px solid var(--red); }
        .logo { font-size: 50px; margin-bottom: 10px; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .menu-item { background: var(--paper); border: 2px solid var(--red); padding: 15px 10px; border-radius: 15px; cursor: pointer; transition: 0.2s; font-size: 14px; font-weight: bold; color: var(--red); box-shadow: 3px 3px 0px var(--red); }
        .menu-item:hover { transform: translate(-2px, -2px); box-shadow: 5px 5px 0px var(--red); background: var(--yellow); }
        .full-width { grid-column: 1 / -1; font-size: 18px; }

        /* é€šç”¨ç»„ä»¶ */
        .section-card { background: white; border-radius: 15px; border: 1px solid #ddd; margin-bottom: 20px; overflow: hidden; }
        .section-header { background: var(--red); color: white; padding: 12px 15px; font-weight: bold; display: flex; justify-content: space-between; }
        .input-row { padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; align-items: flex-start; gap: 12px; }
        .input-body { flex-grow: 1; }
        .input-body label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 6px; color: #555; }
        input, textarea, select { width: 100%; border: 1px solid #eee; padding: 10px; border-radius: 8px; box-sizing: border-box; background: #fafafa; }

        /* å…³ç³»ç½‘çœ‹æ¿ */
        #relation-net { width: 100%; height: 400px; background: white; border-radius: 15px; border: 2px solid var(--red); margin-top: 10px; }

        /* æ—¶é—´è½´æ ·å¼ */
        .timeline-item { border-left: 4px solid var(--red); margin-left: 20px; padding: 10px 20px; position: relative; background: white; margin-bottom: 10px; border-radius: 0 10px 10px 0; }
        .timeline-item::before { content: ''; width: 15px; height: 15px; background: var(--yellow); border: 3px solid var(--red); position: absolute; left: -12.5px; top: 15px; border-radius: 50%; }

        /* ä¹‹å‰çš„æŠ«è¨é¢„è§ˆæ ·å¼ï¼ˆä¿æŒä¸å˜ï¼‰ */
        .receipt-preview { background: var(--paper); border: 2px dashed var(--red); padding: 25px; margin-top: 20px; position: relative; color: #333; }
        .v-img-container { width: 100%; height: 280px; background: #eee; border-radius: 5px; overflow: hidden; margin-bottom: 15px; position: relative; }
        #v-img { width: 100%; height: 100%; object-fit: cover; }
        .stat-bar { background: rgba(0,0,0,0.1); height: 10px; border-radius: 5px; margin: 4px 0 12px 0; overflow: hidden; }
        .stat-fill { background: linear-gradient(90deg, var(--yellow), var(--red)); height: 100%; transition: 0.3s; }

        .back-btn { background: var(--dark); color: white; border: none; padding: 10px 20px; border-radius: 10px; margin-bottom: 15px; cursor: pointer; }
        .save-btn { background: var(--green); color: white; border: none; padding: 15px; border-radius: 15px; width: 100%; font-size: 18px; font-weight: bold; margin-top: 20px; cursor: pointer; box-shadow: 0 5px 0px #1e8449; }
        
        #toast { visibility: hidden; min-width: 250px; background-color: var(--dark); color: #fff; text-align: center; border-radius: 10px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div id="toast">ğŸ• æ“ä½œæˆåŠŸï¼</div>

    <div id="page1" class="page active">
        <div class="main-menu">
            <div class="logo">ğŸ•</div>
            <h1 style="color: var(--red); margin: 0;">åˆ›ä½œå·¥åŠ Pro</h1>
            <p style="color: #666; font-size: 12px;">PIZZA SHOP & WORLD ENGINE</p>
            <div class="menu-grid">
                <div class="menu-item full-width" onclick="createNewPizza()">âœ¨ åˆ¶ä½œä¸“å± OC</div>
                <div class="menu-item" onclick="showCollection()">ğŸ“¦ æˆ‘çš„æŠ«è¨åº“</div>
                <div class="menu-item" onclick="goPage(4)">ğŸ“œ ä¸–ç•Œè§‚è®¾å®š</div>
                <div class="menu-item" onclick="initRelationNet()">ğŸ•¸ï¸ äººç‰©å…³ç³»ç½‘</div>
                <div class="menu-item" onclick="renderTimelinePage()">â³ ç¼–å¹´å²/æ—¶é—´è½´</div>
            </div>
        </div>
    </div>

    <div id="page2" class="page">
        <button class="back-btn" onclick="handleBack()">â† è¿”å›</button>
        <div class="color-picker-wrap" style="margin-bottom:10px;">
            <label>å°ç¥¨é¢œè‰²ï¼š</label><input type="color" id="paperColor" value="#fffcf2" oninput="changePaperColor(this.value)">
        </div>

        <div class="section-card">
            <div class="section-header">åŸºç¡€æ¡£æ¡ˆ</div>
            <div class="input-row"><div class="input-body"><label>ä¸Šä¼ ç«‹ç»˜</label><input type="file" id="imgInput" multiple onchange="appendImages(this)"></div></div>
            <div class="input-row"><div class="input-body"><label>äº§å“åç§°</label><input type="text" id="name" oninput="update()"><button onclick="randomName()">ğŸ² éšæœº</button></div></div>
            <div class="input-row"><div class="input-body"><label>é¥¼åº•ç±»å‹</label><input type="text" id="type" oninput="update()"></div></div>
            <div class="input-row"><div class="input-body"><label>é£å‘³è°ƒæ–™</label><input type="text" id="tags" oninput="update()"></div></div>
        </div>
        <div class="section-card">
            <div class="section-header">å±æ€§ä¸è®¾å®š</div>
            <div class="input-row"><div class="input-body"><label>ç¾å‘³åº¦</label><input type="range" id="stat1" oninput="update()"></div></div>
            <div class="input-row"><div class="input-body"><label>é…æ–™ç”Ÿå¹³</label><textarea id="bio" oninput="update()"></textarea></div></div>
        </div>

        <div id="receipt" class="receipt-preview">
            <h3 style="text-align:center;">PIZZA-OC</h3>
            <div class="v-img-container"><img src="" id="v-img"></div>
            <p><b>å“å:</b> <span id="v-name">---</span></p>
            <p><b>é¥¼åº•:</b> <span id="v-type">---</span></p>
            <div class="stat-bar"><div id="v-bar1" class="stat-fill"></div></div>
            <p style="font-size:12px;"><b>[è®¾å®š]</b> <span id="v-bio">---</span></p>
        </div>
        <button class="save-btn" onclick="fullArchiveSave()">ğŸ“¦ ä¿å­˜å¹¶å¯¼å‡º</button>
    </div>

    <div id="page3" class="page">
        <button class="back-btn" onclick="goPage(1)">â† è¿”å›é¦–é¡µ</button>
        <div id="pizza-list" class="pizza-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
    </div>

    <div id="page4" class="page">
        <button class="back-btn" onclick="goPage(1)">â† è¿”å›é¦–é¡µ</button>
        <h2 style="color:var(--red);">ğŸ“œ ä¸–ç•Œè§‚èµ„æ–™åº“</h2>
        <div class="section-card">
            <div class="section-header">æ·»åŠ è®¾å®šç« èŠ‚</div>
            <div class="input-row">
                <div class="input-body">
                    <input type="text" id="world-title" placeholder="ç« èŠ‚æ ‡é¢˜ (å¦‚ï¼šåœ°ç†ç¯å¢ƒ)">
                    <textarea id="world-content" rows="5" placeholder="è¯¦ç»†è®¾å®šå†…å®¹..." style="margin-top:10px;"></textarea>
                    <button class="save-btn" onclick="saveWorldSetting()">â• ä¿å­˜ç« èŠ‚</button>
                </div>
            </div>
        </div>
        <div id="world-list"></div>
    </div>

    <div id="page5" class="page">
        <button class="back-btn" onclick="goPage(1)">â† è¿”å›é¦–é¡µ</button>
        <h2 style="color:var(--red);">ğŸ•¸ï¸ äººç‰©å…³ç³»ç½‘</h2>
        <div class="section-card">
            <div class="section-header">å»ºç«‹è”ç³»</div>
            <div class="input-row">
                <select id="rel-from"></select>
                <input type="text" id="rel-label" placeholder="å…³ç³» (å¦‚: å®¿æ•Œ)">
                <select id="rel-to"></select>
                <button onclick="addRelation()" style="padding:10px; background:var(--blue); color:white; border:none; border-radius:5px;">è¿çº¿</button>
            </div>
        </div>
        <div id="relation-net"></div>
        <p style="font-size:12px; color:#666;">* æ‹–åŠ¨åœ†ç‚¹å¯ä»¥è°ƒæ•´å¸ƒå±€</p>
    </div>

    <div id="page6" class="page">
        <button class="back-btn" onclick="goPage(1)">â† è¿”å›é¦–é¡µ</button>
        <h2 style="color:var(--red);">â³ å¤§äº‹è®°æ—¶é—´è½´</h2>
        <div class="section-card">
            <div class="section-header">è®°å½•å†å²</div>
            <div class="input-row">
                <div class="input-body">
                    <input type="text" id="time-year" placeholder="æ—¶æœŸ/å¹´ä»½">
                    <input type="text" id="time-event" placeholder="äº‹ä»¶åç§°" style="margin-top:5px;">
                    <textarea id="time-desc" placeholder="äº‹ä»¶è¯¦æƒ…..." style="margin-top:5px;"></textarea>
                    <button class="save-btn" style="background:var(--blue);" onclick="addTimeline()">ğŸ–‹ï¸ è½½å…¥å²å†Œ</button>
                </div>
            </div>
        </div>
        <div id="timeline-container"></div>
    </div>

    <script>
        // --- æ ¸å¿ƒå˜é‡ ---
        let imgList = [];
        let editingId = null;
        let network = null;

        // --- è·¯ç”±ä¸åŸºç¡€åŠŸèƒ½ (ä¿æŒåŸæœ‰) ---
        function goPage(num) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page' + num).classList.add('active');
            window.scrollTo(0,0);
        }

        function handleBack() { editingId ? showCollection() : goPage(1); }

        function showToast(msg) {
            const x = document.getElementById("toast");
            x.innerText = msg || "ğŸ• æ“ä½œæˆåŠŸï¼";
            x.className = "show";
            setTimeout(() => x.className = x.className.replace("show", ""), 3000);
        }

        // --- OC åˆ¶ä½œé€»è¾‘ (ä¿æŒåŸæœ‰åŠŸèƒ½) ---
        function createNewPizza() {
            editingId = null;
            document.querySelectorAll('#page2 input, #page2 textarea').forEach(i => i.value = "");
            imgList = [];
            update();
            goPage(2);
        }

        function update() {
            document.getElementById('v-name').innerText = document.getElementById('name').value || "---";
            document.getElementById('v-type').innerText = document.getElementById('type').value || "---";
            document.getElementById('v-bio').innerText = document.getElementById('bio').value || "---";
            document.getElementById('v-bar1').style.width = document.getElementById('stat1').value + "%";
            if(imgList.length > 0) document.getElementById('v-img').src = imgList[0];
        }

        function appendImages(input) {
            if (input.files) {
                Array.from(input.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => { imgList.push(e.target.result); update(); };
                    reader.readAsDataURL(file);
                });
            }
        }

        function fullArchiveSave() {
            const data = {
                id: editingId || Date.now(),
                name: document.getElementById('name').value || "æœªå‘½å",
                type: document.getElementById('type').value,
                bio: document.getElementById('bio').value,
                stat1: document.getElementById('stat1').value,
                images: imgList
            };
            html2canvas(document.getElementById('receipt')).then(canvas => {
                data.previewShot = canvas.toDataURL();
                let col = JSON.parse(localStorage.getItem('pizzaArchives') || '[]');
                if(editingId) {
                    let idx = col.findIndex(p => p.id === editingId);
                    col[idx] = data;
                } else { col.push(data); }
                localStorage.setItem('pizzaArchives', JSON.stringify(col));
                showToast(editingId ? "ä¿®æ”¹æˆåŠŸï¼" : "æ–°OCå‡ºç‚‰æˆåŠŸï¼");
                if(!editingId) { /* ä¸è·³è½¬ */ } else { showCollection(); }
            });
        }

        // --- 1. ä¸–ç•Œè§‚è®¾å®šé€»è¾‘ ---
        function saveWorldSetting() {
            const title = document.getElementById('world-title').value;
            const content = document.getElementById('world-content').value;
            if(!title) return alert("è¯·è¾“å…¥æ ‡é¢˜");
            let world = JSON.parse(localStorage.getItem('worldSettings') || '[]');
            world.push({ title, content });
            localStorage.setItem('worldSettings', JSON.stringify(world));
            document.getElementById('world-title').value = '';
            document.getElementById('world-content').value = '';
            renderWorldList();
        }

        function renderWorldList() {
            const container = document.getElementById('world-list');
            const settings = JSON.parse(localStorage.getItem('worldSettings') || '[]');
            container.innerHTML = settings.map((s, idx) => `
                <div class="section-card">
                    <div class="section-header">${s.title} <span onclick="deleteWorld(${idx})">ğŸ—‘ï¸</span></div>
                    <div style="padding:15px; font-size:14px; white-space:pre-wrap;">${s.content}</div>
                </div>
            `).join('');
        }
        function deleteWorld(idx) {
            let world = JSON.parse(localStorage.getItem('worldSettings'));
            world.splice(idx,1);
            localStorage.setItem('worldSettings', JSON.stringify(world));
            renderWorldList();
        }

        // --- 2. å…³ç³»ç½‘é€»è¾‘ ---
        function initRelationNet() {
            goPage(5);
            const ocs = JSON.parse(localStorage.getItem('pizzaArchives') || '[]');
            const selFrom = document.getElementById('rel-from');
            const selTo = document.getElementById('rel-to');
            const options = ocs.map(o => `<option value="${o.id}">${o.name}</option>`).join('');
            selFrom.innerHTML = selTo.innerHTML = options;

            const relations = JSON.parse(localStorage.getItem('pizzaRelations') || '[]');
            
            const nodes = new vis.DataSet(ocs.map(o => ({ id: o.id, label: o.name, shape: 'circularImage', image: o.images[0] || '' })));
            const edges = new vis.DataSet(relations);

            const container = document.getElementById('relation-net');
            const data = { nodes, edges };
            const optionsNet = {
                nodes: { borderWidth: 4, size: 30, color: { border: '#d63031', background: '#fff' } },
                edges: { color: '#2d3436', font: { align: 'top' }, arrows: 'to' }
            };
            network = new vis.Network(container, data, optionsNet);
        }

        function addRelation() {
            const from = document.getElementById('rel-from').value;
            const to = document.getElementById('rel-to').value;
            const label = document.getElementById('rel-label').value;
            if(from === to) return alert("ä¸èƒ½å’Œè‡ªå·±å»ºç«‹å…³ç³»");
            let relations = JSON.parse(localStorage.getItem('pizzaRelations') || '[]');
            relations.push({ from, to, label });
            localStorage.setItem('pizzaRelations', JSON.stringify(relations));
            initRelationNet();
        }

        // --- 3. æ—¶é—´è½´é€»è¾‘ ---
        function addTimeline() {
            const year = document.getElementById('time-year').value;
            const event = document.getElementById('time-event').value;
            const desc = document.getElementById('time-desc').value;
            let timeline = JSON.parse(localStorage.getItem('pizzaTimeline') || '[]');
            timeline.push({ year, event, desc });
            localStorage.setItem('pizzaTimeline', JSON.stringify(timeline));
            renderTimelinePage();
        }

        function renderTimelinePage() {
            goPage(6);
            const timeline = JSON.parse(localStorage.getItem('pizzaTimeline') || '[]');
            const container = document.getElementById('timeline-container');
            container.innerHTML = timeline.map(t => `
                <div class="timeline-item">
                    <div style="font-weight:bold; color:var(--red);">${t.year}</div>
                    <div style="font-size:16px; font-weight:bold; margin:5px 0;">${t.event}</div>
                    <div style="font-size:13px; color:#666;">${t.desc}</div>
                </div>
            `).join('');
        }

        // åˆå§‹åŠ è½½
        window.onload = () => {
            renderWorldList();
        };
    </script>
</body>
</html>
